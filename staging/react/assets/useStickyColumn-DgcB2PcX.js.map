{"version":3,"file":"useStickyColumn-DgcB2PcX.js","sources":["../../src/components/Datagrid/useStickyColumn.ts"],"sourcesContent":["/**\n * Copyright IBM Corp. 2021, 2025\n *\n * This source code is licensed under the Apache-2.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport { useEffect, useRef, useState, MutableRefObject } from 'react';\nimport { useIsomorphicEffect } from '../../global/js/hooks';\nimport { debounce } from '../../global/js/utils/debounce';\nimport cx from 'classnames';\nimport { pkg } from '../../settings';\nimport {\n  CellPropGetter,\n  HeaderPropGetter,\n  Hooks,\n  TableBodyPropGetter,\n  TableInstance,\n} from 'react-table';\nimport {\n  DataGridState,\n  DataGridTableProps,\n  DatagridColumn,\n  DataGridData,\n} from './types';\n\nconst blockClass = `${pkg.prefix}--datagrid`;\n\nconst styleClassPrefix = `${blockClass}__right-sticky-column`;\nconst leftStickyStyleClassPrefix = `${blockClass}__left-sticky-column`;\nconst OFFSET_SCROLL_CLASS = `${styleClassPrefix}-offset-scroll`;\n\nconst useStickyColumn = (hooks: Hooks) => {\n  const tableBodyRef = useRef<HTMLElement | undefined>(undefined);\n  const stickyHeaderCellRef = useRef<HTMLElement | undefined>(undefined);\n  const [windowSize, setWindowSize] = useState<number | undefined>(undefined);\n\n  useEffect(() => {\n    setWindowSize(window?.innerWidth);\n  }, []);\n\n  useIsomorphicEffect(() => {\n    /* istanbul ignore next */\n    function updateSize() {\n      setWindowSize(window.innerWidth);\n    }\n    /* istanbul ignore next */\n    window.addEventListener('resize', updateSize);\n    return () => window.removeEventListener('resize', updateSize);\n  }, []);\n\n  hooks.getCellProps.push(\n    changeProps.bind(null, 'cell', null, windowSize) as CellPropGetter<any>\n  );\n  hooks.getHeaderProps.push(\n    changeProps.bind(\n      null,\n      'header',\n      stickyHeaderCellRef,\n      windowSize\n    ) as HeaderPropGetter<any>\n  );\n  hooks.getTableBodyProps.push(\n    addTableBodyProps.bind(null, tableBodyRef) as TableBodyPropGetter<any>\n  );\n  hooks.getHeaderGroupProps.push((props) => [\n    props,\n    {\n      style: {\n        ...props.style,\n        minWidth: 'unset', // unset the min-width calculated by sum of all column min-width\n      },\n    },\n  ]);\n  const useEventListener = (instance: TableInstance & DataGridState) => {\n    useEffect(() => {\n      const tableBodyElement = tableBodyRef.current;\n      const headerCellElement = stickyHeaderCellRef?.current;\n      /* istanbul ignore next */\n      if (hasVertScroll(tableBodyElement) && headerCellElement) {\n        headerCellElement?.classList?.add(OFFSET_SCROLL_CLASS);\n      }\n      const boundListener = debounce(\n        onBodyResize.bind(null, tableBodyElement, headerCellElement),\n        250\n      );\n      /* istanbul ignore next */\n      if (typeof window !== 'undefined') {\n        window.addEventListener('resize', boundListener);\n      }\n      return () => {\n        /* istanbul ignore next */\n        if (typeof window !== 'undefined') {\n          window.removeEventListener('resize', boundListener);\n        }\n      };\n    }, [instance.rows, instance.isFetching]);\n    useEffect(() => {\n      const tableBodyElement = tableBodyRef.current;\n      const headerCellElement = stickyHeaderCellRef.current;\n      const listener = (evt) => {\n        toggleStickyShadow(evt.target, headerCellElement);\n      };\n      toggleStickyShadow(tableBodyElement, headerCellElement);\n      if (tableBodyElement) {\n        tableBodyElement?.addEventListener('scroll', listener);\n      }\n      return () => {\n        if (tableBodyElement) {\n          tableBodyElement.removeEventListener('scroll', listener);\n        }\n      };\n    }, [instance.rows, instance.isFetching]);\n  };\n  const useCheckScroll = (instance) => {\n    const tableBodyElement = tableBodyRef.current;\n    const headerCellElement = stickyHeaderCellRef.current;\n    useEffect(() => {\n      onBodyResize(tableBodyElement, headerCellElement);\n    }, [instance.rows, headerCellElement, tableBodyElement]);\n  };\n  hooks.useInstance.push(useEventListener as (instance: TableInstance) => void);\n  hooks.useInstance.push(useCheckScroll);\n  hooks.useInstance.push((instance) => {\n    Object.assign(instance, {\n      withStickyColumn: true,\n    });\n  });\n  hooks.useInstance.push((instance: TableInstance) => {\n    // sticky column is defined by consumer\n    // it will always comes after the spacer which is defined by useFlexResize\n    // swap them here to use the spacer to push\n    // sticky column to the right when there are few\n    // columns defined\n    const newColumns = instance.visibleColumns;\n    let spacerIdx = newColumns.findIndex((col) => col.id === 'spacer');\n    let stickyIdx = newColumns.findIndex(\n      (col) => (col as DatagridColumn).sticky === 'right'\n    );\n    if (spacerIdx >= 0 && stickyIdx >= 0 && stickyIdx < spacerIdx) {\n      const temp = newColumns[spacerIdx];\n      newColumns[spacerIdx] = newColumns[stickyIdx];\n      newColumns[stickyIdx] = temp;\n    }\n    const newHeaders = instance.headers as DatagridColumn[];\n    spacerIdx = newHeaders.findIndex((col) => col.id === 'spacer');\n    stickyIdx = newHeaders.findIndex(\n      (col) => (col as DatagridColumn).sticky === 'right'\n    );\n\n    if (spacerIdx >= 0 && stickyIdx >= 0 && stickyIdx < spacerIdx) {\n      const temp = newHeaders[spacerIdx];\n      newHeaders[spacerIdx] = newHeaders[stickyIdx];\n      newHeaders[spacerIdx].canResize = false;\n      newHeaders[spacerIdx].disableResizing = true;\n      delete newHeaders[spacerIdx].getResizerProps;\n      newHeaders[stickyIdx] = temp;\n    }\n  });\n};\n\nconst addTableBodyProps = (\n  tableBodyRef: HTMLElement | MutableRefObject<HTMLElement | undefined>,\n  props: DataGridTableProps\n) => [\n  props,\n  {\n    ref: tableBodyRef,\n  },\n];\n\nconst changeProps = (\n  elementName: string,\n  headerCellRef: HTMLElement | MutableRefObject<HTMLElement | undefined> | null,\n  windowSize: number | undefined,\n  props: DataGridTableProps,\n  data: DataGridData\n) => {\n  const column = data.column || data.cell?.column;\n  if (column?.sticky === 'right') {\n    return [\n      props,\n      {\n        className: cx({\n          [`${styleClassPrefix}-${elementName}`]: true,\n          [`${blockClass}__resizableColumn`]: false,\n          [`${blockClass}__sortableColumn`]: false,\n        }),\n        ...(headerCellRef && {\n          ref: headerCellRef,\n        }),\n      },\n    ];\n  }\n  if (column?.sticky === 'left') {\n    return [\n      props,\n      {\n        className: cx({\n          [`${leftStickyStyleClassPrefix}-${elementName}`]:\n            windowSize && windowSize > 671,\n          [`${leftStickyStyleClassPrefix}-${elementName}--with-extra-select-column`]:\n            data?.instance?.withSelectRows && windowSize && windowSize > 671,\n        }),\n        ...(headerCellRef && {\n          ref: headerCellRef,\n        }),\n      },\n    ];\n  }\n  return [props];\n};\n\nconst onBodyResize = (\n  tableBodyEle: HTMLElement | undefined,\n  headerCellEle: HTMLElement | undefined\n) => {\n  if (headerCellEle) {\n    /* istanbul ignore next */\n    if (hasVertScroll(tableBodyEle)) {\n      headerCellEle.classList.add(OFFSET_SCROLL_CLASS);\n    } else {\n      headerCellEle.classList.remove(OFFSET_SCROLL_CLASS);\n    }\n    toggleStickyShadow(tableBodyEle, headerCellEle);\n  }\n};\n\nconst toggleStickyShadow = (\n  tableBodyEle: HTMLElement | undefined,\n  headerCellEle: HTMLElement | undefined\n) => {\n  /* istanbul ignore next */\n  if (tableBodyEle && headerCellEle) {\n    const isScrolledToRight =\n      tableBodyEle.scrollLeft + tableBodyEle.clientWidth ===\n      tableBodyEle.scrollWidth;\n    if (isScrolledToRight) {\n      headerCellEle.classList.add(`${blockClass}__sticky-noShadow`);\n      tableBodyEle.classList.add(`${blockClass}__sticky-column-noShadow`);\n    } else {\n      headerCellEle.classList.remove(`${blockClass}__sticky-noShadow`);\n      tableBodyEle.classList.remove(`${blockClass}__sticky-column-noShadow`);\n    }\n  }\n};\nconst hasVertScroll = (element: HTMLElement | undefined) => {\n  /* istanbul ignore next */\n  if (!element) {\n    return false;\n  }\n  const { scrollHeight, clientHeight } = element;\n  return scrollHeight > clientHeight;\n};\n\nexport default useStickyColumn;\n"],"names":["blockClass","pkg","styleClassPrefix","leftStickyStyleClassPrefix","OFFSET_SCROLL_CLASS","useStickyColumn","hooks","tableBodyRef","useRef","stickyHeaderCellRef","windowSize","setWindowSize","useState","useEffect","useIsomorphicEffect","updateSize","changeProps","addTableBodyProps","props","useEventListener","instance","tableBodyElement","headerCellElement","hasVertScroll","boundListener","debounce","onBodyResize","listener","evt","toggleStickyShadow","useCheckScroll","newColumns","spacerIdx","col","stickyIdx","temp","newHeaders","elementName","headerCellRef","data","column","cx","tableBodyEle","headerCellEle","element","scrollHeight","clientHeight"],"mappings":"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"}